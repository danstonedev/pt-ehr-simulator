<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Site Menu Test</title>
    <style>
      body {
        padding: 16px;
        font:
          14px/1.4 system-ui,
          Segoe UI,
          Roboto,
          Arial,
          sans-serif;
      }
      .result {
        margin-top: 12px;
        padding: 8px 10px;
        border-radius: 8px;
      }
      .pass {
        background: #e6ffed;
        color: #046b1c;
        border: 1px solid #a6f4c5;
      }
      .fail {
        background: #ffeff0;
        color: #8a041a;
        border: 1px solid #ffd0d4;
      }

      /* Minimal styles to visualize menu + overlay without relying on media queries */
      .site-menu {
        position: fixed;
        top: 0;
        right: 0;
        width: 300px;
        height: 100vh;
        background: #141821;
        color: #e6ebf5;
        border-left: 1px solid #232a36;
        transform: translateX(100%);
        transition: transform 0.2s ease;
        outline: none;
      }
      .site-menu.is-open {
        transform: translateX(0);
      }
      .site-menu-panel {
        height: 100%;
        overflow: auto;
        padding: 12px;
        display: flex;
        flex-direction: column;
        gap: 10px;
      }
      .site-menu .btn.block {
        width: 100%;
        text-align: center;
      }

      .site-menu-overlay {
        position: fixed;
        inset: 0;
        background: rgba(0, 0, 0, 0.45);
        display: none;
      }
      .site-menu-overlay.is-visible {
        display: block;
      }

      .btn {
        padding: 8px 10px;
        border-radius: 8px;
        border: 1px solid #2a3242;
        background: #1a2130;
        color: #e6ebf5;
      }
      .btn.small {
        font-size: 12px;
      }
    </style>
  </head>
  <body>
    <h1>Site Menu Test</h1>
    <p>
      Ensures hamburger (.hamburger-btn) toggles site menu (#siteMenu) and overlay visibility, and
      traps focus.
    </p>

    <button class="hamburger-btn" type="button" aria-expanded="false" aria-controls="siteMenu">
      Hamburger
    </button>

    <nav id="siteMenu" class="site-menu" aria-label="Site menu" aria-hidden="true" tabindex="-1">
      <div class="site-menu-panel">
        <button class="btn small block site-menu-close" type="button">Close</button>
        <a class="btn block" href="#link1">Link 1</a>
        <button id="innerBtn" class="btn block" type="button">Inner Button</button>
      </div>
    </nav>

    <div id="results" class="result">Runningâ€¦</div>

    <script type="module">
      import { initSiteMenu } from '../js/features/navigation/siteMenu.js';
      const nextTick = () => new Promise((r) => setTimeout(r, 0));
      const waitFor = async (fn, timeoutMs = 1500) => {
        const start = Date.now();
        while (!fn()) {
          if (Date.now() - start > timeoutMs) return false;
          await new Promise((r) => setTimeout(r, 10));
        }
        return true;
      };
      (async () => {
        const res = document.getElementById('results');
        const errors = [];
        function assert(cond, msg) {
          if (!cond) errors.push(msg);
        }

        const btn = document.querySelector('.hamburger-btn');
        const menu = document.getElementById('siteMenu');
        const closeBtn = menu.querySelector('.site-menu-close');
        const innerBtn = document.getElementById('innerBtn');
        const overlay = (function () {
          return (
            document.getElementById('siteMenuOverlay') ||
            document.querySelector('.site-menu-overlay')
          );
        })();

        // Initialize and wait for binding
        initSiteMenu();
        const bound = await waitFor(() => !!btn && !!btn._siteMenuBound);
        assert(bound, 'Menu not bound');

        // Initial state
        assert(btn && menu && closeBtn && innerBtn, 'Elements missing');
        assert(!menu.classList.contains('is-open'), 'Menu should start closed');
        assert(btn.getAttribute('aria-expanded') === 'false', 'aria-expanded should start false');

        // Open via hamburger
        btn.click();
        const opened = await waitFor(() => menu.classList.contains('is-open'));
        assert(opened, 'Open failed');
        assert(
          btn.getAttribute('aria-expanded') === 'true',
          'aria-expanded should be true after open',
        );
        if (overlay)
          assert(overlay.classList.contains('is-visible'), 'Overlay should be visible after open');
        assert(
          menu.getAttribute('aria-hidden') === 'false',
          'aria-hidden should be false when open',
        );

        // Focus trap: Tab from last goes to first
        const firstFocusable = closeBtn; // First in panel
        innerBtn.focus();
        const evTab = new KeyboardEvent('keydown', { key: 'Tab', bubbles: true });
        document.dispatchEvent(evTab);
        const wrappedToFirst = await waitFor(() => document.activeElement === firstFocusable);
        assert(wrappedToFirst, 'Tab from last should wrap to first');

        // Focus trap: Shift+Tab from first goes to last
        firstFocusable.focus();
        const evShiftTab = new KeyboardEvent('keydown', {
          key: 'Tab',
          shiftKey: true,
          bubbles: true,
        });
        document.dispatchEvent(evShiftTab);
        const wrappedToLast = await waitFor(() => document.activeElement === innerBtn);
        assert(wrappedToLast, 'Shift+Tab from first should wrap to last');

        // Close via close button
        closeBtn.click();
        const closed = await waitFor(() => !menu.classList.contains('is-open'));
        assert(closed, 'Close failed');
        assert(
          btn.getAttribute('aria-expanded') === 'false',
          'aria-expanded should be false after close',
        );
        if (overlay)
          assert(!overlay.classList.contains('is-visible'), 'Overlay should be hidden after close');

        res.textContent = errors.length ? 'FAIL: ' + errors.join('; ') : 'PASS';
        res.className = 'result ' + (errors.length ? 'fail' : 'pass');
        console.log('Site Menu Test:', errors.length ? 'FAIL' : 'PASS', errors);
      })();
    </script>
  </body>
</html>

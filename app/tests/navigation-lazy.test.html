<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Navigation Lazy Load Smoke Test</title>
    <style>
      body {
        font-family:
          system-ui,
          -apple-system,
          Segoe UI,
          Roboto,
          sans-serif;
        padding: 16px;
      }
      .pass {
        color: #0a7;
      }
      .fail {
        color: #c00;
      }
      pre {
        background: #f6f8fa;
        padding: 8px;
        border-radius: 6px;
        overflow: auto;
      }
      .test {
        margin-bottom: 16px;
      }
      #mount {
        display: grid;
        grid-template-columns: 280px 1fr;
        gap: 16px;
        align-items: start;
      }
      .chart-navigation {
        border: 1px solid #e5e7eb;
        border-radius: 8px;
        padding: 8px;
        min-height: 40px;
      }
    </style>
  </head>
  <body>
    <h1>Navigation Lazy Load Smoke Test</h1>
    <div id="results"></div>
    <div id="mount">
      <aside id="sidebar"></aside>
      <section>
        <div class="editor subjective-section">
          <a class="section-anchor" id="hpi">
            <h4 class="subsection-title">HPI</h4>
            <div>content</div>
          </a>
          <a class="section-anchor" id="pain-assessment">
            <h4 class="subsection-title">Pain Assessment</h4>
            <div>content</div>
          </a>
        </div>
      </section>
    </div>

    <script type="module">
      import { loadNavigationBundle } from '../js/features/navigation/api.js';

      const results = document.getElementById('results');
      const log = (name, ok, details = '') => {
        const div = document.createElement('div');
        div.className = 'test';
        div.innerHTML =
          `<strong>${ok ? '✅' : '❌'} ${name}</strong>` + (details ? `<pre>${details}</pre>` : '');
        div.classList.add(ok ? 'pass' : 'fail');
        results.appendChild(div);
      };

      try {
        const { createChartNavigation, refreshChartNavigation } = await loadNavigationBundle();

        const config = {
          activeSection: 'subjective',
          isFacultyMode: true,
          caseData: {
            editorSettings: { visibility: { subjective: { hpi: true, 'pain-assessment': false } } },
          },
          onEditorSettingsChange: (next) => {
            window.__lastEditorSettings = next;
          },
        };

        // 1) Create sidebar (should return placeholder first, then hydrate)
        const sidebarMount = document.getElementById('sidebar');
        const el = createChartNavigation(config);
        sidebarMount.appendChild(el);
        const isPlaceholder =
          el && el.classList.contains('chart-navigation') && el.style.opacity === '0.001';
        log('Sidebar placeholder created', isPlaceholder);

        // 2) Wait a tick for hydration
        await new Promise((r) => setTimeout(r, 50));
        const currentSidebar = document.querySelector('#sidebar .chart-navigation');
        const hydrated =
          currentSidebar && currentSidebar !== el && currentSidebar.style.opacity !== '0.001';
        log('Sidebar hydrated (replaced placeholder)', !!hydrated);

        // 3) Verify visibility controls applied (HPI visible, Pain Assessment hidden)
        const hpi = document.querySelector('.subjective-section #hpi');
        const pain = document.querySelector('.subjective-section #pain-assessment');
        const visApplied =
          hpi &&
          hpi.style.display !== 'none' &&
          pain &&
          (pain.style.display === 'none' || pain.style.display === '');
        log(
          'Visibility controls applied',
          !!visApplied,
          `hpi.display=${hpi?.style.display}; pain.display=${pain?.style.display}`,
        );

        // 4) Trigger refresh and ensure sidebar swaps again
        await refreshChartNavigation(currentSidebar, { ...config });
        await new Promise((r) => setTimeout(r, 50));
        const refreshedSidebar = document.querySelector('#sidebar .chart-navigation');
        log('Sidebar refreshed via replace', !!refreshedSidebar);
      } catch (e) {
        log('Unhandled error in nav test', false, String(e?.stack || e));
      }
    </script>
  </body>
</html>

<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
      <!-- Microsoft Forms Feedback Embed -->
    <meta name="ms-forms-url" content="https://forms.office.com/Pages/ResponsePage.aspx?id=DQSIkWdsW0yxEjajBLZtrQAAAAAAAAAAAAGOOEaDTU0VTjQwuUNYNFAzSU5MUDNVTENWNjJFT1hOUC4u">
  <title>PT Sim-ER (MVP v2)</title>
  <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 16 16'><rect width='16' height='16' fill='%23007acc'/><text x='8' y='12' text-anchor='middle' fill='white' font-family='Arial' font-size='10' font-weight='bold'>E</text></svg>">
  <link rel="stylesheet" href="css/styles.css?v=20250820-003" />
  <link rel="stylesheet" href="css/sidebar.css?v=20250818-002" />
  <link rel="stylesheet" href="css/print.css" media="print" />
  <!-- Webfont: Oswald (Trade Gothic alternative) for brand label -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Oswald:wght@500;600;700&display=swap" rel="stylesheet">
  <!-- Add docx generation library -->
  <script src="https://unpkg.com/docx@6.0.3/build/index.js"></script>
  <script src="https://unpkg.com/file-saver@2.0.5/dist/FileSaver.min.js"></script>
</head>
<body>
  <!-- Skip to main content for keyboard and screen reader users -->
  <a class="skip-link" href="#app">Skip to main content</a>
  <header class="topbar no-print">
    <div class="brand-row">
      <a class="brand und-logo-link" href="#/" aria-label="University of North Dakota Home">
    <img class="und-logo" src="img/und-logotype-fullw.svg" alt="University of North Dakota" loading="eager" decoding="async" />
  <span class="brand-label">Physical Therapy EHR Simulator <span class="brand-label-suffix">| Proof of Concept</span></span>
      </a>
      <button id="feedbackBtn" class="btn orange small feedback-btn" type="button" aria-haspopup="dialog" aria-controls="feedbackDialog">Feedback</button>
    </div>
    <nav id="primaryNav" class="topnav" role="navigation" aria-label="Primary">
      <a href="#/">Home</a>
      <a href="#/student/cases">Student</a>
      <a href="#/instructor/cases">Faculty</a>
      <button id="themeToggle" class="theme-toggle switch is-light" onclick="toggleTheme()" role="switch" aria-checked="false" aria-label="Switch to dark theme">
        <span class="switch-track" aria-hidden="true"></span>
        <span class="switch-thumb" aria-hidden="true">
          <span class="icon sun" aria-hidden="true">‚òÄÔ∏è</span>
          <span class="icon moon" aria-hidden="true">üåô</span>
        </span>
      </button>
    </nav>
  </header>

  <main id="app"></main>

  <!-- Removed Netlify form (no Netlify integration) -->

  <!-- Educational ribbon at page bottom -->
  <div class="edu-ribbon no-print" role="note" aria-label="Educational Use Only">
    <span class="edu-left">Educational Use Only</span>
    <span class="edu-right" id="lastUpdateText" aria-live="polite"></span>
  </div>

  <!-- Removed fixed footer disclaimer to prevent blocking content -->

  <script>
    // Theme toggle functionality
  function toggleTheme() {
      const root = document.documentElement;
      const toggle = document.getElementById('themeToggle');
      const isLight = root.getAttribute('data-theme') === 'light';
      if (isLight) {
        // Switch to dark
        root.removeAttribute('data-theme');
        localStorage.setItem('theme', 'dark');
        toggle.setAttribute('aria-checked', 'true');
        toggle.setAttribute('aria-label', 'Switch to light theme');
        toggle.classList.add('is-dark');
        toggle.classList.remove('is-light');
      } else {
        // Switch to light
        root.setAttribute('data-theme', 'light');
        localStorage.setItem('theme', 'light');
        toggle.setAttribute('aria-checked', 'false');
        toggle.setAttribute('aria-label', 'Switch to dark theme');
        toggle.classList.add('is-light');
        toggle.classList.remove('is-dark');
      }
    }
    
    // Load saved theme on page load
    document.addEventListener('DOMContentLoaded', function() {
      const savedTheme = localStorage.getItem('theme') || 'light'; // Default to light mode
      const toggle = document.getElementById('themeToggle');
      
      if (savedTheme === 'light') {
        document.documentElement.setAttribute('data-theme', 'light');
        toggle.setAttribute('aria-checked', 'false');
        toggle.setAttribute('aria-label', 'Switch to dark theme');
        toggle.classList.add('is-light');
        toggle.classList.remove('is-dark');
      } else {
        document.documentElement.removeAttribute('data-theme');
        toggle.setAttribute('aria-checked', 'true');
        toggle.setAttribute('aria-label', 'Switch to light theme');
        toggle.classList.add('is-dark');
        toggle.classList.remove('is-light');
      }

      // Last Update (GitHub) ribbon text
      (function setupLastUpdate() {
        const el = document.getElementById('lastUpdateText');
        if (!el) return;
        // Show a quick placeholder
        el.textContent = '';
        const CACHE_KEY = 'last_update_cache_v1';
        const CACHE_TTL_MS = 1000 * 60 * 30; // 30 minutes
        const owner = 'danstonedev';
        const repo = 'pt-ehr-simulator';
        const branch = 'main';

        function formatDateTime(d) {
          try {
            const dt = typeof d === 'string' ? new Date(d) : d;
            return dt.toLocaleString(undefined, {
              year: 'numeric', month: 'short', day: '2-digit',
              hour: '2-digit', minute: '2-digit'
            });
          } catch {
            return '';
          }
        }

        function apply(dateStr) {
          if (!dateStr) return;
          el.textContent = `Last update: ${formatDateTime(dateStr)}`;
        }

        try {
          const cachedRaw = localStorage.getItem(CACHE_KEY);
          if (cachedRaw) {
            const cached = JSON.parse(cachedRaw);
            if (cached.time && (Date.now() - cached.time) < CACHE_TTL_MS && cached.date) {
              apply(cached.date);
            }
          }
        } catch {}

        // Fetch from GitHub (unauthenticated; low rate limits but okay for a small page)
        fetch(`https://api.github.com/repos/${owner}/${repo}/commits/${branch}`)
          .then(r => r.ok ? r.json() : Promise.reject(r.status))
          .then(data => {
            const dateStr = data && data.commit && data.commit.committer && data.commit.committer.date;
            if (dateStr) {
              apply(dateStr);
              try {
                localStorage.setItem(CACHE_KEY, JSON.stringify({ time: Date.now(), date: dateStr }));
              } catch {}
            }
          })
          .catch(() => {
            // If offline or rate-limited, leave cached value (if any). Otherwise noop.
          });
      })();

      // Feedback modal wiring
      const feedbackBtn = document.getElementById('feedbackBtn');
      if (feedbackBtn) {
        feedbackBtn.addEventListener('click', () => {
          // Try to resolve an MS Forms URL from multiple sources for flexibility
          const metaEl = document.querySelector('meta[name="feedback-form-url"]');
          const configuredUrl = (metaEl && metaEl.content) || window.FEEDBACK_FORM_URL || localStorage.getItem('feedbackFormUrl') || '';

          const overlay = document.createElement('div');
          overlay.id = 'feedbackDialog';
          overlay.style.cssText = 'position:fixed;inset:0;background:rgba(0,0,0,.5);display:flex;align-items:center;justify-content:center;z-index:10000;';
          overlay.addEventListener('click', (e) => { if (e.target === overlay) document.body.removeChild(overlay); });

          const panel = document.createElement('div');
          panel.style.cssText = 'background:#fff;padding:24px;border-radius:12px;width:92%;max-width:560px;box-shadow:0 20px 25px -5px rgba(0,0,0,.1);color:#111;';
          if (configuredUrl) {
            // Build an embeddable URL (ensure embed=true present)
            let formSrc = configuredUrl.trim();
            if (!/embed=true/i.test(formSrc)) {
              formSrc += (formSrc.includes('?') ? '&' : '?') + 'embed=true';
            }
            panel.innerHTML = `
              <h2 style="margin:0 0 8px 0;">Send Feedback</h2>
              <p class="small" style="margin:0 0 12px 0;color:#4b5563;">This form is embedded from Microsoft Forms.</p>
              <div style="width:100%;height:560px;">
                <iframe title="Feedback Form" src="${formSrc}" width="100%" height="100%" frameborder="0" marginwidth="0" marginheight="0" allowfullscreen webkitallowfullscreen mozallowfullscreen style="border:1px solid var(--input-border); border-radius:12px; background:#fff;"></iframe>
              </div>
              <div style="display:flex;gap:8px;justify-content:flex-end;margin-top:12px;">
                <button class="btn secondary" type="button" id="cancelFeedback">Close</button>
                <a class="btn orange" id="openFormNewTab" href="${formSrc}" target="_blank" rel="noopener noreferrer">Open in new tab</a>
              </div>
            `;
          } else {
            panel.innerHTML = `
              <h2 style="margin:0 0 8px 0;">Send Feedback</h2>
              <p class="small" style="margin:0 0 12px 0;color:#4b5563;">Share any issues or ideas. Your comments help improve the simulator.</p>
              <label for="feedbackText" class="form-label-standard" style="display:block;margin-bottom:6px;">Your feedback</label>
              <textarea id="feedbackText" rows="6" style="width:100%;box-sizing:border-box;border:1px solid var(--input-border);border-radius:8px;padding:10px;font-family:inherit;font-size:14px;resize:vertical;"></textarea>
              <div style="display:flex;gap:8px;justify-content:flex-end;margin-top:12px;">
                <button class="btn secondary" type="button" id="cancelFeedback">Cancel</button>
                <button class="btn orange" type="button" id="sendFeedback">Send Feedback</button>
              </div>
            `;
          }

          overlay.appendChild(panel);
          document.body.appendChild(overlay);
          if (!configuredUrl) { document.getElementById('feedbackText').focus(); }

          panel.querySelector('#cancelFeedback').addEventListener('click', () => {
            document.body.removeChild(overlay);
          });
          if (!configuredUrl) {
            // Helper to URL-encode form data
            const encodeForm = (data) => Object.keys(data)
              .map((k) => encodeURIComponent(k) + '=' + encodeURIComponent(data[k]))
              .join('&');

            panel.querySelector('#sendFeedback').addEventListener('click', async () => {
              const text = (panel.querySelector('#feedbackText').value || '').trim();
              if (!text) { alert('Please enter your feedback before sending.'); return; }
              const subjectTxt = 'PT EHR Simulator Feedback';
              // Send via mailto
              const subject = encodeURIComponent(subjectTxt);
              const body = encodeURIComponent(text + '\n\n‚Äî Sent from PT EHR Simulator');
              window.location.href = `mailto:daniel.j.stone@UND.edu?subject=${subject}&body=${body}`;
              document.body.removeChild(overlay);
            });
          }
        });
      }
    });
  </script>
  <script type="module" src="js/core/router.js?v=20250818-003"></script>
</body>
</html>
